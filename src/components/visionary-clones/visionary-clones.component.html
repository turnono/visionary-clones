<div class="w-full max-w-5xl mx-auto">
  <header class="text-center mb-10">
    <h1 class="text-5xl font-extrabold tracking-tight text-white sm:text-6xl md:text-7xl">
      <span class="bg-clip-text text-transparent bg-gradient-to-r from-purple-400 to-pink-600">Visionary</span>Clones
    </h1>
    <p class="mt-4 text-lg text-gray-400">From Topic to Viral Video â€” Orchestrated by Gemini.</p>
  </header>

  @if (generationState() === 'idle' || generationState() === 'error') {
  <div class="bg-gray-800/50 backdrop-blur-sm rounded-2xl p-8 border border-gray-700 shadow-2xl shadow-purple-500/10">

    @if(generationState() === 'error' || errorMessage()) {
    <div class="bg-red-900/50 border border-red-700 text-red-300 p-4 rounded-lg mb-6">
      <h3 class="font-bold">An Error Occurred</h3>
      <p>{{ errorMessage() }}</p>
    </div>
    }

    <!-- API Key Configuration Section -->
    <div class="mb-6 p-6 bg-gray-900/50 rounded-lg border border-gray-700">
      <div class="flex items-center justify-between mb-4">
        <h3 class="text-lg font-semibold text-white">Google AI API Key</h3>
        @if (hasApiKey()) {
        <span
          class="inline-flex items-center gap-1.5 px-3 py-1 rounded-full text-xs font-medium bg-green-900/50 text-green-300 border border-green-700">
          <svg class="w-3 h-3" fill="currentColor" viewBox="0 0 20 20">
            <path fill-rule="evenodd"
              d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z"
              clip-rule="evenodd" />
          </svg>
          Configured
        </span>
        } @else {
        <span
          class="inline-flex items-center gap-1.5 px-3 py-1 rounded-full text-xs font-medium bg-yellow-900/50 text-yellow-300 border border-yellow-700">
          <svg class="w-3 h-3" fill="currentColor" viewBox="0 0 20 20">
            <path fill-rule="evenodd"
              d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z"
              clip-rule="evenodd" />
          </svg>
          Required
        </span>
        }
      </div>

      @if (!hasApiKey() || showApiKeyInput()) {
      <div class="space-y-3">
        <p class="text-sm text-gray-400">Enter your Google AI API key to use Gemini and Imagen models. <a
            href="https://aistudio.google.com/apikey" target="_blank"
            class="text-purple-400 hover:text-purple-300 underline">Get your API key here</a>.</p>
        <div class="flex gap-2">
          <input type="password" [(ngModel)]="apiKeyInput" placeholder="Enter your API key"
            class="flex-1 rounded-md border-0 bg-white/5 py-2 px-3 text-white shadow-sm ring-1 ring-inset ring-white/10 focus:ring-2 focus:ring-inset focus:ring-purple-500 sm:text-sm">
          <button (click)="saveApiKey()" [disabled]="!apiKeyInput.trim()"
            class="px-4 py-2 rounded-md bg-purple-600 text-white font-semibold hover:bg-purple-700 disabled:opacity-50 disabled:cursor-not-allowed transition-colors">
            Save
          </button>
        </div>
      </div>
      } @else {
      <div class="flex items-center justify-between">
        <p class="text-sm text-gray-400">API key is configured and ready to use.</p>
        <button (click)="toggleApiKeyInput()" class="text-sm text-purple-400 hover:text-purple-300 underline">
          Change Key
        </button>
      </div>
      }
    </div>

    <!-- v1.2: Progress Bar -->
    @if (generationState() !== 'idle' && generationState() !== 'error') {
    <div class="mb-8 bg-gray-800/30 rounded-lg p-4 border border-gray-700">
      <div class="flex items-center justify-between mb-2">
        <span class="text-sm font-medium text-gray-300">Step {{ currentStep() }} of {{ totalSteps }}</span>
        <span class="text-sm text-purple-400">{{ getStepName(currentStep()) }}</span>
      </div>
      <div class="w-full bg-gray-700 rounded-full h-2.5">
        <div
          class="bg-gradient-to-r from-purple-500 to-pink-500 h-2.5 rounded-full transition-all duration-500 ease-out"
          [style.width.%]="(currentStep() / totalSteps) * 100"></div>
      </div>
    </div>
    }

    <div class="grid grid-cols-1 md:grid-cols-2 gap-8 items-start">
      <div class="space-y-6">
        <div>
          <label class="block text-sm font-medium text-gray-300 mb-2">1. Upload Your "Identity Lock" Portrait
            (Optional)</label>
          <div
            class="mt-2 flex justify-center rounded-lg border border-dashed bg-gray-900/50 px-6 py-10 transition-colors"
            [class]="isDragging() ? 'border-purple-500' : 'border-gray-600'" (dragover)="onDragOver($event)"
            (dragleave)="onDragLeave($event)" (drop)="onDrop($event)">
            <div class="text-center">
              @if (referenceImageUrl()) {
              <img [src]="referenceImageUrl()" alt="Reference Portrait"
                class="mx-auto h-32 w-32 rounded-full object-cover mb-4 border-2 border-purple-500">
              } @else {
              <svg class="mx-auto h-12 w-12 text-gray-500" viewBox="0 0 24 24" fill="currentColor" aria-hidden="true">
                <path fill-rule="evenodd"
                  d="M1.5 6a2.25 2.25 0 012.25-2.25h16.5A2.25 2.25 0 0122.5 6v12a2.25 2.25 0 01-2.25 2.25H3.75A2.25 2.25 0 011.5 18V6zM3 16.06V18c0 .414.336.75.75.75h16.5A.75.75 0 0021 18v-1.94l-2.69-2.689a1.5 1.5 0 00-2.12 0l-.88.879.97.97a.75.75 0 11-1.06 1.06l-5.16-5.159a1.5 1.5 0 00-2.12 0L3 16.061zm10.125-7.81a1.125 1.125 0 112.25 0 1.125 1.125 0 01-2.25 0z"
                  clip-rule="evenodd" />
              </svg>
              }
              <div class="mt-4 flex text-sm leading-6 text-gray-400">
                <label for="file-upload"
                  class="relative cursor-pointer rounded-md font-semibold text-purple-400 focus-within:outline-none focus-within:ring-2 focus-within:ring-purple-600 focus-within:ring-offset-2 focus-within:ring-offset-gray-900 hover:text-purple-300">
                  <span>Upload a file</span>
                  <input id="file-upload" name="file-upload" type="file" class="sr-only" (change)="onFileChange($event)"
                    accept="image/png, image/jpeg">
                </label>
                <p class="pl-1">or drag and drop</p>
              </div>
              <p class="text-xs leading-5 text-gray-500">PNG, JPG up to 10MB</p>
            </div>
          </div>
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-300 mb-2">2. Pick Your Persona</label>
          <div class="flex flex-wrap gap-2">
            @for(persona of personas; track persona) {
            <button (click)="selectPersona(persona)"
              [class]="'px-4 py-2 rounded-full text-sm font-semibold transition-all ' + (selectedPersona() === persona ? 'bg-purple-600 text-white shadow-lg' : 'bg-gray-700 hover:bg-gray-600 text-gray-300')">
              {{ persona }}
            </button>
            }
          </div>
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-300 mb-2">3. Music Genre</label>
          <div class="flex flex-wrap gap-2">
            @for(genre of musicGenres; track genre) {
            <button (click)="selectMusicGenre(genre)"
              [class]="'px-3 py-1.5 rounded-full text-xs font-semibold transition-all ' + (selectedMusicGenre() === genre ? 'bg-pink-600 text-white shadow-lg' : 'bg-gray-700 hover:bg-gray-600 text-gray-300')">
              {{ genre }}
            </button>
            }
          </div>
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-300 mb-2">4. Music Mood</label>
          <div class="flex flex-wrap gap-2">
            @for(mood of musicMoods; track mood) {
            <button (click)="selectMusicMood(mood)"
              [class]="'px-3 py-1.5 rounded-full text-xs font-semibold transition-all ' + (selectedMusicMood() === mood ? 'bg-pink-600 text-white shadow-lg' : 'bg-gray-700 hover:bg-gray-600 text-gray-300')">
              {{ mood }}
            </button>
            }
          </div>
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-300 mb-2">5. Music Duration</label>
          <input type="text" value="24 seconds" readonly
            class="block w-full rounded-md bg-gray-800 text-gray-400 px-3 py-2 cursor-not-allowed">
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-300 mb-2">
            6. Music Intensity: {{ musicIntensity() }} ({{ getBpmRangeForIntensity(musicIntensity())[0] }}-{{
            getBpmRangeForIntensity(musicIntensity())[1] }} BPM)
          </label>
          <input type="range" min="1" max="5" [value]="musicIntensity()" (input)="updateMusicIntensity($event)"
            class="w-full h-2 bg-gray-700 rounded-lg appearance-none cursor-pointer accent-purple-500">
          <div class="flex justify-between text-xs text-gray-400 mt-1">
            <span>Calm (60-75)</span>
            <span>Medium (80-95)</span>
            <span>Energetic (100-115)</span>
          </div>
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-300 mb-2">7. Image Quality</label>
          <div class="flex flex-wrap gap-2">
            @for(model of imageModelQualities; track model.value) {
            <button (click)="selectImageModel(model.value)"
              [class]="'px-3 py-1.5 rounded-full text-xs font-semibold transition-all ' + (selectedImageModel() === model.value ? 'bg-indigo-600 text-white shadow-lg' : 'bg-gray-700 hover:bg-gray-600 text-gray-300')"
              [title]="model.description">
              {{ model.label }}
            </button>
            }
          </div>
        </div>
      </div>

      <div class="space-y-6">
        <div>
          <label for="topic" class="block text-sm font-medium text-gray-300">8. Enter Your Topic</label>
          <div class="mt-2">
            <textarea name="topic" id="topic" (input)="updateTopic($event)" [value]="topic()" rows="3"
              class="block w-full rounded-md border-0 bg-white/5 py-2 px-3 text-white shadow-sm ring-1 ring-inset ring-white/10 focus:ring-2 focus:ring-inset focus:ring-purple-500 sm:text-sm sm:leading-6"
              placeholder="e.g., The future of AI"></textarea>
          </div>
        </div>

        <div>
          <label for="props-upload" class="block text-sm font-medium text-gray-300 mb-2">9. Props (Optional - up to 3
            images)</label>
          <input type="file" id="props-upload" multiple accept="image/*" (change)="onPropsUpload($event)"
            class="block w-full text-sm text-gray-400 file:mr-4 file:py-2 file:px-4 file:rounded-md file:border-0 file:text-sm file:font-semibold file:bg-purple-600 file:text-white hover:file:bg-purple-700 file:cursor-pointer">
          @if (propsUrls().length > 0) {
          <div class="mt-3 flex gap-2">
            @for(url of propsUrls(); track url; let i = $index) {
            <img [src]="url" alt="Prop {{ i + 1 }}" class="w-16 h-16 object-cover rounded border border-purple-500">
            }
          </div>
          }
        </div>
        <div class="pt-6">
          <button (click)="generate()" [disabled]="!isFormValid()"
            class="w-full flex justify-center items-center gap-2 rounded-md bg-gradient-to-r from-purple-500 to-pink-500 px-6 py-4 text-lg font-semibold text-white shadow-lg transition-transform duration-200 hover:scale-105 disabled:opacity-50 disabled:cursor-not-allowed disabled:scale-100">
            Generate Vision
          </button>
        </div>
      </div>
    </div>
  </div>
  }

  @if (generationState() !== 'idle' && generationState() !== 'done' && generationState() !== 'error') {
  <div
    class="bg-gray-800/50 backdrop-blur-sm rounded-2xl p-8 border border-gray-700 shadow-2xl shadow-purple-500/10 w-full text-center">
    <div class="flex justify-center items-center mb-4">
      <svg class="animate-spin -ml-1 mr-3 h-8 w-8 text-purple-400" xmlns="http://www.w3.org/2000/svg" fill="none"
        viewBox="0 0 24 24">
        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
        <path class="opacity-75" fill="currentColor"
          d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z">
        </path>
      </svg>
    </div>
    <h2 class="text-2xl font-bold text-white mb-2">Orchestrating Your Vision...</h2>
    <p class="text-gray-400">{{ loadingMessage() }}</p>

    <div class="mt-8 grid grid-cols-1 md:grid-cols-3 gap-6">
      @for (item of [0, 1, 2]; track item) {
      <div
        class="aspect-[9/16] bg-gray-900 rounded-lg flex items-center justify-center border border-dashed border-gray-700">
        @if (storyboardImages()[item]) {
        <img [src]="storyboardImages()[item]" alt="Storyboard preview" class="w-full h-full object-cover rounded-lg">
        }
      </div>
      }
    </div>
  </div>
  }

  @if (generationState() === 'done') {
  <div class="w-full space-y-8">
    <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
      @for(image of storyboardImages(); track image; let i = $index) {
      <div class="rounded-2xl overflow-hidden border border-purple-500/30 shadow-2xl shadow-purple-500/10">
        <h3 class="bg-gray-800 text-center py-2 font-semibold text-purple-300">{{ script()[i].beat }}</h3>
        <img class="w-full aspect-[9/16]" [src]="image" alt="Storyboard for {{ script()[i].beat }}">
        <p class="p-4 text-sm bg-gray-900/50 text-gray-300 italic">"{{ script()[i].script }}"</p>
      </div>
      }
    </div>

    @if (musicResult()) {
    <div class="bg-gray-800/50 backdrop-blur-sm rounded-2xl p-6 border border-gray-700">
      <h3 class="text-xl font-bold text-white mb-3">ðŸŽµ Music Prompt</h3>
      <div class="space-y-2 text-sm">
        <p class="text-gray-300"><span class="font-semibold text-purple-400">Genre:</span> {{ musicResult()!.genre }}
        </p>
        <p class="text-gray-300"><span class="font-semibold text-purple-400">Mood:</span> {{ musicResult()!.mood }}</p>
        <p class="text-gray-300"><span class="font-semibold text-purple-400">Duration:</span> {{ musicResult()!.duration
          }}</p>
        <p class="text-gray-400 mt-3 italic">"{{ musicResult()!.prompt }}"</p>
      </div>
    </div>
    }

    <div class="flex flex-col items-center gap-4 mt-8">
      <button (click)="downloadBundle()"
        class="rounded-md bg-gradient-to-r from-purple-500 to-pink-500 px-8 py-4 text-lg font-semibold text-white shadow-lg hover:shadow-xl transition-all">
        ðŸ“¦ Download Complete Bundle
      </button>

      <!-- v1.2: Individual download options -->
      <div class="flex flex-wrap gap-3 justify-center">
        <button (click)="downloadScriptOnly()"
          class="text-sm px-4 py-2 rounded-md bg-gray-700 hover:bg-gray-600 text-gray-200 transition-colors">
          ðŸ“„ Script Only
        </button>
        <button (click)="downloadStoryboardsOnly()"
          class="text-sm px-4 py-2 rounded-md bg-gray-700 hover:bg-gray-600 text-gray-200 transition-colors">
          ðŸŽ¨ Storyboards
        </button>
        <button (click)="downloadMusicPromptOnly()"
          class="text-sm px-4 py-2 rounded-md bg-gray-700 hover:bg-gray-600 text-gray-200 transition-colors">
          ðŸŽµ Music Prompt
        </button>
      </div>

      <button (click)="resetState()"
        class="rounded-md bg-gray-700 px-6 py-3 text-lg font-semibold text-white shadow-lg transition-transform duration-200 hover:bg-gray-600 hover:scale-105">
        Create Another
      </button>
    </div>
  </div>
  }
</div>